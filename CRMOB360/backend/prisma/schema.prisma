// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Modelos baseados no esquema de banco de dados definido

model usuarios {
  id                  String    @id @default(dbgenerated("gen_random_uuid()"))
  email               String    @unique @db.VarChar(255)
  senha_hash          String    @db.VarChar(255)
  nome                String    @db.VarChar(255)
  telefone            String?   @db.VarChar(20)
  tipo_usuario        String    @db.VarChar(50)
  ativo               Boolean   @default(true)
  avatar_url          String?
  created_at          DateTime  @default(now())
  updated_at          DateTime  @default(now()) @updatedAt
  ultimo_acesso       DateTime?
  config_notificacoes Json      @default("{}")

  // Relacionamentos
  clientes_responsavel      clientes[]      @relation("Responsavel")
  clientes_criado_por       clientes[]      @relation("CriadoPor")
  atividades_realizadas     atividades[]    @relation("AtividadeRealizada")
  imoveis_responsavel       imoveis[]       @relation("ImovelResponsavel")
  imoveis_criado_por        imoveis[]       @relation("ImovelCriadoPor")
  usuario_perfis            usuario_perfil[]
  imovel_chaves             imovel_chaves[]
  imovel_documentos         imovel_documentos[]
  pipeline_leads            pipeline_leads[]
  processos                 processos[]
  tarefas_processo          tarefas_processo[]
  agendamentos_visita       agendamentos_visita[]
  documentos_compartilhados documentos_compartilhados[]

  @@map("usuarios")
}

model perfis_acesso {
  id          String   @id @default(dbgenerated("gen_random_uuid()"))
  nome        String   @db.VarChar(100)
  descricao   String?
  permissoes  Json
  created_at  DateTime @default(now())
  
  usuario_perfis usuario_perfil[]
  
  @@map("perfis_acesso")
}

model usuario_perfil {
  usuario_id String
  perfil_id  String
  
  usuario usuarios      @relation(fields: [usuario_id], references: [id])
  perfil  perfis_acesso @relation(fields: [perfil_id], references: [id])
  
  @@id([usuario_id, perfil_id])
  @@map("usuario_perfil")
}

model clientes {
  id              String    @id @default(dbgenerated("gen_random_uuid()"))
  nome            String    @db.VarChar(255)
  email           String?   @db.VarChar(255)
  telefone        String?   @db.VarChar(20)
  cpf_cnpj        String?   @db.VarChar(20)
  tipo_pessoa     String    @default("fisica") @db.VarChar(20)
  origem          String?   @db.VarChar(100)
  status_lead     String    @default("novo") @db.VarChar(50)
  score_ia        Int       @default(0)
  perfil_busca    Json      @default("{}")
  responsavel_id  String?
  criado_por      String?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @default(now()) @updatedAt
  ultimo_contato  DateTime?
  tags            String[]
  custom_fields   Json      @default("{}")

  // Relacionamentos
  responsavel           usuarios?                     @relation("Responsavel", fields: [responsavel_id], references: [id])
  criador               usuarios?                     @relation("CriadoPor", fields: [criado_por], references: [id])
  atividades            atividades[]
  pipeline_leads        pipeline_leads[]
  imoveis_proprietario  imoveis[]                     @relation("Proprietario")
  contratos_locatario   contratos_locacao[]           @relation("Locatario")
  contratos_fiador      contratos_locacao[]           @relation("Fiador")
  propostas_cliente     propostas[]                   @relation("PropostaCliente")
  contas_financeiras    contas_financeiras[]
  solicitacoes_lgpd     solicitacoes_lgpd[]
  portal_sessions       portal_sessions[]
  imoveis_favoritos     imoveis_favoritos[]
  agendamentos_visita   agendamentos_visita[]
  notificacoes_portal   notificacoes_portal[]
  portal_activities     portal_activities[]
  documentos_compartilhados documentos_compartilhados[]

  @@map("clientes")
}

model funis_venda {
  id         String   @id @default(dbgenerated("gen_random_uuid()"))
  nome       String   @db.VarChar(255)
  descricao  String?
  tipo       String   @db.VarChar(50)
  etapas     Json
  ativo      Boolean  @default(true)
  created_at DateTime @default(now())
  
  pipeline_leads pipeline_leads[]
  
  @@map("funis_venda")
}

model pipeline_leads {
  id                  String    @id @default(dbgenerated("gen_random_uuid()"))
  cliente_id          String
  funil_id            String
  etapa_atual         String    @db.VarChar(100)
  valor_estimado      Decimal?  @db.Decimal(15, 2)
  data_entrada_etapa  DateTime  @default(now())
  previsao_fechamento DateTime? @db.Date
  responsavel_id      String?
  created_at          DateTime  @default(now())
  updated_at          DateTime  @default(now()) @updatedAt

  cliente     clientes      @relation(fields: [cliente_id], references: [id])
  funil       funis_venda   @relation(fields: [funil_id], references: [id])
  responsavel usuarios?     @relation(fields: [responsavel_id], references: [id])
  
  @@map("pipeline_leads")
}

model atividades {
  id               String    @id @default(dbgenerated("gen_random_uuid()"))
  cliente_id       String
  tipo             String    @db.VarChar(50)
  descricao        String
  data_hora        DateTime  @default(now())
  realizado_por    String?
  duracao_minutos  Int?
  resultado          String?   @db.VarChar(50)
  proxima_acao     DateTime? @db.Date
  anexos           Json      @default("[]")

  cliente      clientes @relation(fields: [cliente_id], references: [id])
  usuario      usuarios? @relation("AtividadeRealizada", fields: [realizado_por], references: [id])
  
  @@map("atividades")
}

model imoveis {
  id                   String    @id @default(dbgenerated("gen_random_uuid()"))
  codigo               String    @unique @db.VarChar(50)
  titulo               String    @db.VarChar(255)
  descricao            String?
  tipo_imovel          String    @db.VarChar(50)
  finalidade           String    @db.VarChar(20)
  status               String    @default("disponivel") @db.VarChar(50)
  proprietario_id      String?
  responsavel_id       String?
  cep                  String?   @db.VarChar(10)
  logradouro           String?   @db.VarChar(255)
  numero               String?   @db.VarChar(20)
  complemento          String?   @db.VarChar(255)
  bairro               String?   @db.VarChar(100)
  cidade               String?   @db.VarChar(100)
  uf                   String?   @db.VarChar(2)
  area_total           Decimal?  @db.Decimal(10, 2)
  area_util            Decimal?  @db.Decimal(10, 2)
  quartos              Int?
  suites               Int?
  banheiros            Int?
  vagas_garagem        Int?
  andar                Int?
  valor_venda          Decimal?  @db.Decimal(15, 2)
  valor_locacao        Decimal?  @db.Decimal(15, 2)
  valor_condominio     Decimal?  @db.Decimal(12, 2)
  valor_iptu           Decimal?  @db.Decimal(12, 2)
  publicado_site       Boolean   @default(false)
  publicado_portais    Json      @default("{}")
  fotos                Json      @default("[]")
  videos               Json      @default("[]")
  planta_baixa         String?
  visitas_count        Int       @default(0)
  criado_por           String?
  created_at           DateTime  @default(now())
  updated_at           DateTime  @default(now()) @updatedAt
  tags                 String[]
  custom_fields        Json      @default("{}")

  // Relacionamentos
  proprietario          clientes?              @relation("Proprietario", fields: [proprietario_id], references: [id])
  responsavel           usuarios?              @relation("ImovelResponsavel", fields: [responsavel_id], references: [id])
  criador               usuarios?              @relation("ImovelCriadoPor", fields: [criado_por], references: [id])
  chaves                imovel_chaves[]
  documentos            imovel_documentos[]
  contratos             contratos_locacao[]
  propostas             propostas[]
  contas_financeiras    contas_financeiras[]
  imoveis_favoritos     imoveis_favoritos[]
  agendamentos_visita   agendamentos_visita[]
  documentos_compartilhados documentos_compartilhados[]

  @@map("imoveis")
}

model imovel_chaves {
  id                String    @id @default(dbgenerated("gen_random_uuid()"))
  imovel_id         String
  localizacao       String    @db.VarChar(255)
  status            String    @default("disponivel") @db.VarChar(50)
  emprestada_para   String?
  data_emprestimo   DateTime?
  data_devolucao    DateTime?
  created_at        DateTime  @default(now())

  imovel      imoveis  @relation(fields: [imovel_id], references: [id])
  usuario     usuarios? @relation(fields: [emprestada_para], references: [id])
  
  @@map("imovel_chaves")
}

model imovel_documentos {
  id                  String    @id @default(dbgenerated("gen_random_uuid()"))
  imovel_id           String
  tipo                String    @db.VarChar(100)
  arquivo_url         String
  nome_arquivo        String?   @db.VarChar(255)
  tamanho_bytes       BigInt?
  mime_type           String?   @db.VarChar(100)
  data_vencimento     DateTime? @db.Date
  alerta_vencimento_dias Int    @default(30)
  uploaded_por        String?
  created_at          DateTime  @default(now())

  imovel  imoveis  @relation(fields: [imovel_id], references: [id])
  usuario usuarios? @relation(fields: [uploaded_por], references: [id])
  
  @@map("imovel_documentos")
}

model contratos_locacao {
  id                      String    @id @default(dbgenerated("gen_random_uuid()"))
  numero_contrato         String    @unique @db.VarChar(50)
  imovel_id               String
  locatario_id            String
  fiador_id               String?
  data_inicio             DateTime  @db.Date
  data_fim                DateTime  @db.Date
  prorrogacao_automatica  Boolean   @default(true)
  valor_aluguel           Decimal   @db.Decimal(12, 2)
  valor_condominio        Decimal   @default(0) @db.Decimal(12, 2)
  dia_vencimento          Int
  taxa_administracao      Decimal   @default(10.0) @db.Decimal(5, 2)
  multa_atraso_percentual Decimal   @default(2.0) @db.Decimal(5, 2)
  juros_mora_percentual   Decimal   @default(0.033) @db.Decimal(5, 2)
  status                  String    @default("ativo") @db.VarChar(50)
  motivo_encerramento     String?
  data_encerramento       DateTime? @db.Date
  documento_url           String?
  assinado_digitalmente   Boolean   @default(false)
  created_at              DateTime  @default(now())
  updated_at              DateTime  @default(now()) @updatedAt

  imovel      imoveis @relation(fields: [imovel_id], references: [id])
  locatario   clientes @relation("Locatario", fields: [locatario_id], references: [id])
  fiador      clientes? @relation("Fiador", fields: [fiador_id], references: [id])
  contas_financeiras contas_financeiras[]
  
  @@map("contratos_locacao")
}

model propostas {
  id                    String    @id @default(dbgenerated("gen_random_uuid()"))
  numero_proposta       String    @unique @db.VarChar(50)
  tipo                  String    @db.VarChar(20)
  imovel_id             String
  cliente_id            String
  corretor_id           String?
  valor_proposta        Decimal   @db.Decimal(15, 2)
  valor_sinal           Decimal?  @db.Decimal(15, 2)
  condicoes             String?
  status                String    @default("pendente") @db.VarChar(50)
  data_resposta         DateTime? @db.Date
  motivo_recusa         String?
  documento_url         String?
  assinado_digitalmente Boolean   @default(false)
  created_at            DateTime  @default(now())
  updated_at            DateTime  @default(now()) @updatedAt

  imovel   imoveis @relation(fields: [imovel_id], references: [id])
  cliente  clientes @relation("PropostaCliente", fields: [cliente_id], references: [id])
  
  @@map("propostas")
}

model plano_contas {
  id          String   @id @default(dbgenerated("gen_random_uuid()"))
  codigo      String   @unique @db.VarChar(20)
  nome        String   @db.VarChar(255)
  tipo        String   @db.VarChar(20)
  categoria   String?  @db.VarChar(50)
  parent_id   String?
  ativo       Boolean  @default(true)
  created_at  DateTime @default(now())

  parent      plano_contas? @relation("PlanoContasParent", fields: [parent_id], references: [id])
  children    plano_contas[] @relation("PlanoContasParent")
  contas      contas_financeiras[]
  
  @@map("plano_contas")
}

model centros_custo {
  id          String   @id @default(dbgenerated("gen_random_uuid()"))
  codigo      String   @unique @db.VarChar(20)
  nome        String   @db.VarChar(255)
  descricao   String?
  ativo       Boolean  @default(true)
  created_at  DateTime @default(now())

  contas contas_financeiras[]
  
  @@map("centros_custo")
}

model contas_financeiras {
  id                  String    @id @default(dbgenerated("gen_random_uuid()"))
  numero_documento    String?   @db.VarChar(50)
  tipo                String    @db.VarChar(20)
  plano_conta_id      String
  centro_custo_id     String?
  descricao           String
  valor_original      Decimal   @db.Decimal(15, 2)
  valor_pago          Decimal   @default(0) @db.Decimal(15, 2)
  data_emissao        DateTime  @db.Date
  data_vencimento     DateTime  @db.Date
  data_pagamento      DateTime? @db.Date
  cliente_id          String?
  contrato_id         String?
  imovel_id           String?
  status              String    @default("pendente") @db.VarChar(50)
  gateway_pagamento   String?   @db.VarChar(50)
  boleto_url          String?
  boleto_codigo       String?   @db.VarChar(100)
  criado_por          String?
  created_at          DateTime  @default(now())
  updated_at          DateTime  @default(now()) @updatedAt

  plano_conta     plano_contas    @relation(fields: [plano_conta_id], references: [id])
  centro_custo    centros_custo?  @relation(fields: [centro_custo_id], references: [id])
  cliente         clientes?       @relation(fields: [cliente_id], references: [id])
  contrato        contratos_locacao? @relation(fields: [contrato_id], references: [id])
  imovel          imoveis?        @relation(fields: [imovel_id], references: [id])
  
  @@map("contas_financeiras")
}

model comissoes {
  id                     String    @id @default(dbgenerated("gen_random_uuid()"))
  numero_comissao        String    @unique @db.VarChar(50)
  tipo                   String    @db.VarChar(20)
  venda_id               String?
  locacao_id             String?
  corretor_vendedor_id   String?
  corretor_captador_id   String?
  gerente_id             String?
  valor_total            Decimal   @db.Decimal(15, 2)
  percentual_imobiliaria Decimal   @default(40.0) @db.Decimal(5, 2)
  percentual_vendedor    Decimal   @default(40.0) @db.Decimal(5, 2)
  percentual_captador    Decimal   @default(15.0) @db.Decimal(5, 2)
  percentual_gerente     Decimal   @default(5.0) @db.Decimal(5, 2)
  valor_imobiliaria      Decimal?  @db.Decimal(15, 2)
  valor_vendedor         Decimal?  @db.Decimal(15, 2)
  valor_captador         Decimal?  @db.Decimal(15, 2)
  valor_gerente          Decimal?  @db.Decimal(15, 2)
  status                 String    @default("calculada") @db.VarChar(50)
  data_pagamento         DateTime? @db.Date
  calculada_por          String?
  created_at             DateTime  @default(now())
  updated_at             DateTime  @default(now()) @updatedAt

  @@map("comissoes")
}

model log_consentimento_lgpd {
  id_log                    String    @id @default(dbgenerated("gen_random_uuid()"))
  id_cliente                String
  timestamp_consentimento   DateTime  @db.Timestamptz()
  texto_consentimento_hash  String    @db.VarChar(64)
  id_template_termo         String?
  ip_origem                 String?
  canal_origem              String?   @db.VarChar(100)
  permissao_email_mkt       Boolean   @default(false)
  permissao_whatsapp_mkt    Boolean   @default(false)
  permissao_ia_perfil       Boolean   @default(false)

  cliente clientes @relation(fields: [id_cliente], references: [id])
  
  @@map("log_consentimento_lgpd")
}

model templates_termos {
  id              String    @id @default(dbgenerated("gen_random_uuid()"))
  nome            String    @db.VarChar(255)
  tipo            String    @db.VarChar(50)
  versao          Int       @default(1)
  texto_conteudo  String
  ativo           Boolean   @default(true)
  created_at      DateTime  @default(now())
  updated_at      DateTime  @default(now()) @updatedAt
  
  @@map("templates_termos")
}

model solicitacoes_lgpd {
  id                String    @id @default(dbgenerated("gen_random_uuid()"))
  cliente_id        String
  tipo_solicitacao  String    @db.VarChar(50)
  status            String    @default("pendente") @db.VarChar(50)
  motivo_negacao    String?
  data_atendimento  DateTime? @db.Date
  created_at        DateTime  @default(now())

  cliente clientes @relation(fields: [cliente_id], references: [id])
  
  @@map("solicitacoes_lgpd")
}

model templates_processo {
  id          String   @id @default(dbgenerated("gen_random_uuid()"))
  nome        String   @db.VarChar(255)
  descricao   String?
  tipo        String   @db.VarChar(50)
  etapas      Json
  gatilhos    Json      @default("[]")
  ativo       Boolean  @default(true)
  created_at  DateTime @default(now())

  processos processos[]
  
  @@map("templates_processo")
}

model processos {
  id              String    @id @default(dbgenerated("gen_random_uuid()"))
  template_id     String
  entidade_tipo   String    @db.VarChar(50)
  entidade_id     String
  status          String    @default("ativo") @db.VarChar(50)
  etapa_atual     String?   @db.VarChar(100)
  responsavel_id  String?
  data_inicio     DateTime  @default(now())
  data_conclusao  DateTime?

  template    templates_processo @relation(fields: [template_id], references: [id])
  responsavel usuarios?          @relation(fields: [responsavel_id], references: [id])
  tarefas     tarefas_processo[]
  
  @@map("processos")
}

model tarefas_processo {
  id              String    @id @default(dbgenerated("gen_random_uuid()"))
  processo_id     String
  titulo          String    @db.VarChar(255)
  descricao       String?
  atribuido_para  String?
  prazo           DateTime? @db.Date
  prioridade      String    @default("normal") @db.VarChar(20)
  status          String    @default("pendente") @db.VarChar(50)
  concluida_em    DateTime?
  anexos          Json      @default("[]")
  created_at      DateTime  @default(now())

  processo    processos @relation(fields: [processo_id], references: [id])
  atribuido   usuarios? @relation(fields: [atribuido_para], references: [id])
  
  @@map("tarefas_processo")
}

model configuracoes {
  id          String   @id @default(dbgenerated("gen_random_uuid()"))
  chave       String   @unique @db.VarChar(255)
  valor       Json
  descricao   String?
  categoria   String?  @db.VarChar(50)
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now()) @updatedAt

  @@map("configuracoes")
}

// ============================================
// MODELOS PARA PORTAIS (CLIENTE E PROPRIETÁRIO)
// ============================================

model portal_sessions {
  id              String    @id @default(dbgenerated("gen_random_uuid()"))
  cliente_id      String
  tipo_portal     String    @db.VarChar(20) // 'cliente' ou 'proprietario'
  token_acesso    String    @unique @db.VarChar(500)
  refresh_token   String?   @db.VarChar(500)
  ip_address      String?   @db.VarChar(45)
  user_agent      String?
  ultimo_acesso   DateTime  @default(now())
  expira_em       DateTime
  ativo           Boolean   @default(true)
  created_at      DateTime  @default(now())

  cliente clientes @relation(fields: [cliente_id], references: [id], onDelete: Cascade)

  @@index([cliente_id, tipo_portal])
  @@index([token_acesso])
  @@map("portal_sessions")
}

model imoveis_favoritos {
  id         String   @id @default(dbgenerated("gen_random_uuid()"))
  cliente_id String
  imovel_id  String
  created_at DateTime @default(now())

  cliente clientes @relation(fields: [cliente_id], references: [id], onDelete: Cascade)
  imovel  imoveis  @relation(fields: [imovel_id], references: [id], onDelete: Cascade)

  @@unique([cliente_id, imovel_id])
  @@index([cliente_id])
  @@index([imovel_id])
  @@map("imoveis_favoritos")
}

model agendamentos_visita {
  id                  String    @id @default(dbgenerated("gen_random_uuid()"))
  imovel_id           String
  cliente_id          String
  corretor_id         String?
  data_hora           DateTime
  duracao_minutos     Int       @default(60)
  status              String    @default("agendado") @db.VarChar(50) // agendado, confirmado, realizado, cancelado
  tipo_visita         String    @default("presencial") @db.VarChar(50) // presencial, online
  observacoes         String?
  avaliacao_cliente   Int?      // 1-5 estrelas
  comentario_cliente  String?
  cancelado_por       String?   @db.VarChar(50)
  motivo_cancelamento String?
  created_at          DateTime  @default(now())
  updated_at          DateTime  @default(now()) @updatedAt

  imovel   imoveis  @relation(fields: [imovel_id], references: [id], onDelete: Cascade)
  cliente  clientes @relation(fields: [cliente_id], references: [id], onDelete: Cascade)
  corretor usuarios? @relation(fields: [corretor_id], references: [id])

  @@index([cliente_id])
  @@index([imovel_id])
  @@index([data_hora])
  @@index([status])
  @@map("agendamentos_visita")
}

model notificacoes_portal {
  id         String    @id @default(dbgenerated("gen_random_uuid()"))
  cliente_id String
  tipo       String    @db.VarChar(50) // proposta_atualizada, visita_confirmada, novo_imovel, mensagem
  titulo     String    @db.VarChar(255)
  mensagem   String
  link       String?   @db.VarChar(500)
  lida       Boolean   @default(false)
  lida_em    DateTime?
  created_at DateTime  @default(now())

  cliente clientes @relation(fields: [cliente_id], references: [id], onDelete: Cascade)

  @@index([cliente_id, lida])
  @@index([created_at])
  @@map("notificacoes_portal")
}

model portal_activities {
  id          String   @id @default(dbgenerated("gen_random_uuid()"))
  cliente_id  String
  tipo_portal String   @db.VarChar(20) // 'cliente' ou 'proprietario'
  acao        String   @db.VarChar(100) // login, visualizou_imovel, enviou_proposta, etc
  entidade    String?  @db.VarChar(50) // tipo da entidade (imovel, proposta, documento)
  entidade_id String?  // ID da entidade relacionada
  detalhes    Json     @default("{}")
  ip_address  String?  @db.VarChar(45)
  user_agent  String?
  created_at  DateTime @default(now())

  cliente clientes @relation(fields: [cliente_id], references: [id], onDelete: Cascade)

  @@index([cliente_id, tipo_portal])
  @@index([created_at])
  @@index([acao])
  @@map("portal_activities")
}

model documentos_compartilhados {
  id                  String    @id @default(dbgenerated("gen_random_uuid()"))
  cliente_id          String
  imovel_id           String?
  contrato_id         String?
  tipo_documento      String    @db.VarChar(100)
  titulo              String    @db.VarChar(255)
  arquivo_url         String
  nome_arquivo        String    @db.VarChar(255)
  tamanho_bytes       BigInt?
  mime_type           String?   @db.VarChar(100)
  requer_assinatura   Boolean   @default(false)
  assinado            Boolean   @default(false)
  data_assinatura     DateTime?
  visualizado         Boolean   @default(false)
  visualizado_em      DateTime?
  compartilhado_por   String?
  created_at          DateTime  @default(now())

  cliente     clientes  @relation(fields: [cliente_id], references: [id], onDelete: Cascade)
  imovel      imoveis?  @relation(fields: [imovel_id], references: [id], onDelete: Cascade)
  compartilhou usuarios? @relation(fields: [compartilhado_por], references: [id])

  @@index([cliente_id])
  @@index([imovel_id])
  @@map("documentos_compartilhados")
}

// ============================================
// MÓDULO DE MARKETING
// ============================================

model campanhas_marketing {
  id              String    @id @default(dbgenerated("gen_random_uuid()"))
  codigo          String    @unique @db.VarChar(50)
  nome            String    @db.VarChar(255)
  tipo            String    @db.VarChar(20) // email, sms, whatsapp
  assunto         String?   @db.VarChar(500)
  mensagem        String
  segmentacao     Json      @default("{}")
  status          String    @default("rascunho") @db.VarChar(50) // rascunho, agendada, enviando, enviada, cancelada
  agendamento     DateTime?
  data_envio      DateTime?
  template_id     String?
  total_envios    Int       @default(0)
  total_enviados  Int       @default(0)
  total_erros     Int       @default(0)
  criado_por      String?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @default(now()) @updatedAt

  envios_campanha envios_campanha[]

  @@index([status])
  @@index([tipo])
  @@map("campanhas_marketing")
}

model templates_mensagem {
  id         String   @id @default(dbgenerated("gen_random_uuid()"))
  nome       String   @db.VarChar(255)
  tipo       String   @db.VarChar(20) // email, sms, whatsapp
  assunto    String?  @db.VarChar(500)
  conteudo   String
  variaveis  Json     @default("[]")
  ativo      Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  @@index([tipo])
  @@map("templates_mensagem")
}

model envios_campanha {
  id            String    @id @default(dbgenerated("gen_random_uuid()"))
  campanha_id   String
  cliente_id    String
  status        String    @default("pendente") @db.VarChar(50) // pendente, enviado, erro
  erro          String?
  aberto        Boolean   @default(false)
  data_abertura DateTime?
  clicado       Boolean   @default(false)
  data_clique   DateTime?
  created_at    DateTime  @default(now())

  campanha campanhas_marketing @relation(fields: [campanha_id], references: [id], onDelete: Cascade)
  cliques  cliques_campanha[]

  @@index([campanha_id])
  @@index([cliente_id])
  @@index([status])
  @@map("envios_campanha")
}

model cliques_campanha {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  envio_id  String
  link      String
  created_at DateTime @default(now())

  envio envios_campanha @relation(fields: [envio_id], references: [id], onDelete: Cascade)

  @@index([envio_id])
  @@map("cliques_campanha")
}

// ============================================
// WHATSAPP
// ============================================

model mensagens_whatsapp {
  id         String   @id @default(dbgenerated("gen_random_uuid()"))
  message_id String?  @db.VarChar(255)
  telefone   String   @db.VarChar(20)
  tipo       String   @db.VarChar(50) // text, template, image, document, audio, video
  conteudo   String
  status     String   @default("pendente") @db.VarChar(50) // pendente, enviada, entregue, lida, recebida, erro, failed
  erro       String?
  direcao    String   @default("saida") @db.VarChar(20) // saida, entrada
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  @@index([telefone])
  @@index([status])
  @@index([message_id])
  @@map("mensagens_whatsapp")
}

// ============================================
// PAGAMENTOS
// ============================================

model transacoes_pagamento {
  id                 String   @id @default(dbgenerated("gen_random_uuid()"))
  conta_id           String?
  gateway            String   @db.VarChar(50) // asaas, pagseguro, mercadopago
  gateway_payment_id String?  @db.VarChar(255)
  valor              Decimal  @db.Decimal(15, 2)
  status             String   @default("pending") @db.VarChar(50) // pending, confirmed, received, overdue, refunded, cancelled
  tipo               String?  @db.VarChar(50) // boleto, pix, credit_card, debit_card
  metadados          Json     @default("{}")
  created_at         DateTime @default(now())
  updated_at         DateTime @default(now()) @updatedAt

  @@index([conta_id])
  @@index([gateway_payment_id])
  @@index([status])
  @@map("transacoes_pagamento")
}

// ============================================
// PUBLICAÇÃO EM PORTAIS
// ============================================

model portal_integracoes {
  id             String   @id @default(dbgenerated("gen_random_uuid()"))
  nome           String   @unique @db.VarChar(100) // vivareal, zapimoveis, olx
  ativo          Boolean  @default(true)
  credenciais    Json // api_key, secret, etc (criptografado)
  configuracoes  Json     @default("{}")
  created_at     DateTime @default(now())
  updated_at     DateTime @default(now()) @updatedAt

  publicacoes publicacoes_portal[]

  @@map("portal_integracoes")
}

model publicacoes_portal {
  id                    String    @id @default(dbgenerated("gen_random_uuid()"))
  imovel_id             String
  portal_id             String
  portal_listing_id     String?   @db.VarChar(255) // ID do anúncio no portal
  status                String    @default("publicado") @db.VarChar(50) // publicado, pausado, removido, erro
  data_publicacao       DateTime?
  data_remocao          DateTime?
  erro                  String?
  visualizacoes         Int       @default(0)
  leads_gerados         Int       @default(0)
  ultima_sincronizacao  DateTime?
  created_at            DateTime  @default(now())
  updated_at            DateTime  @default(now()) @updatedAt

  portal portal_integracoes @relation(fields: [portal_id], references: [id], onDelete: Cascade)
  leads  leads_portais[]

  @@unique([imovel_id, portal_id])
  @@index([imovel_id])
  @@index([portal_id])
  @@index([status])
  @@map("publicacoes_portal")
}

model leads_portais {
  id             String    @id @default(dbgenerated("gen_random_uuid()"))
  publicacao_id  String
  nome           String    @db.VarChar(255)
  email          String?   @db.VarChar(255)
  telefone       String?   @db.VarChar(20)
  mensagem       String?
  origem         String    @db.VarChar(100) // vivareal, zapimoveis, etc
  cliente_id     String? // Se já foi convertido em cliente
  created_at     DateTime  @default(now())

  publicacao publicacoes_portal @relation(fields: [publicacao_id], references: [id], onDelete: Cascade)

  @@index([publicacao_id])
  @@index([cliente_id])
  @@map("leads_portais")
}

// ============================================
// AUDITORIA
// ============================================

model logs_auditoria {
  id               String   @id @default(dbgenerated("gen_random_uuid()"))
  usuario_id       String?
  acao             String   @db.VarChar(100) // create, update, delete, login, logout, etc
  entidade         String?  @db.VarChar(100) // clientes, imoveis, contas_financeiras, etc
  entidade_id      String?
  dados_anteriores Json?
  dados_novos      Json?
  ip_address       String?  @db.VarChar(45)
  user_agent       String?
  created_at       DateTime @default(now())

  @@index([usuario_id])
  @@index([acao])
  @@index([entidade, entidade_id])
  @@index([created_at])
  @@map("logs_auditoria")
}

// ============================================
// NOTIFICAÇÕES AVANÇADAS
// ============================================

model notificacoes_sistema {
  id             String    @id @default(dbgenerated("gen_random_uuid()"))
  usuario_id     String
  tipo           String    @db.VarChar(50) // info, warning, error, success
  categoria      String?   @db.VarChar(50) // tarefa, processo, financeiro, lead, etc
  titulo         String    @db.VarChar(255)
  mensagem       String
  link           String?   @db.VarChar(500)
  lida           Boolean   @default(false)
  lida_em        DateTime?
  acao_principal Json? // {label: 'Ver', url: '/...'}
  created_at     DateTime  @default(now())

  @@index([usuario_id, lida])
  @@index([created_at])
  @@map("notificacoes_sistema")
}

// ============================================
// DASHBOARDS E ANALYTICS
// ============================================

model metricas_sistema {
  id                  String   @id @default(dbgenerated("gen_random_uuid()"))
  data                DateTime @unique @db.Date
  total_clientes      Int      @default(0)
  total_leads         Int      @default(0)
  total_imoveis       Int      @default(0)
  imoveis_disponiveis Int      @default(0)
  total_visitas       Int      @default(0)
  total_propostas     Int      @default(0)
  receita_dia         Decimal  @default(0) @db.Decimal(15, 2)
  despesa_dia         Decimal  @default(0) @db.Decimal(15, 2)
  metricas_extras     Json     @default("{}")
  created_at          DateTime @default(now())

  @@map("metricas_sistema")
}

// ============================================
// CONFIGURAÇÕES AVANÇADAS
// ============================================

model config_integracoes {
  id            String   @id @default(dbgenerated("gen_random_uuid()"))
  tipo          String   @db.VarChar(50) // email, whatsapp, payment, portal
  nome          String   @db.VarChar(100)
  ativo         Boolean  @default(false)
  credenciais   Json
  configuracoes Json     @default("{}")
  created_at    DateTime @default(now())
  updated_at    DateTime @default(now()) @updatedAt

  @@index([tipo])
  @@map("config_integracoes")
}

// ============================================
// WEBHOOKS
// ============================================

model webhooks_recebidos {
  id            String    @id @default(dbgenerated("gen_random_uuid()"))
  origem        String    @db.VarChar(100) // whatsapp, asaas, vivareal, etc
  evento        String    @db.VarChar(100)
  payload       Json
  processado    Boolean   @default(false)
  processado_em DateTime?
  erro          String?
  created_at    DateTime  @default(now())

  @@index([origem])
  @@index([processado])
  @@map("webhooks_recebidos")
}

// ============================================
// AUTOMAÇÕES
// ============================================

model regras_automacao {
  id                 String   @id @default(dbgenerated("gen_random_uuid()"))
  nome               String   @db.VarChar(255)
  descricao          String?
  trigger_tipo       String   @db.VarChar(100) // novo_lead, visita_agendada, proposta_recebida, etc
  trigger_condicoes  Json     @default("{}")
  acoes              Json // [{tipo: 'enviar_email', config: {...}}, ...]
  ativo              Boolean  @default(true)
  created_at         DateTime @default(now())
  updated_at         DateTime @default(now()) @updatedAt

  execucoes execucoes_automacao[]

  @@index([trigger_tipo])
  @@map("regras_automacao")
}

model execucoes_automacao {
  id            String    @id @default(dbgenerated("gen_random_uuid()"))
  regra_id      String
  entidade_tipo String?   @db.VarChar(100)
  entidade_id   String?
  status        String    @default("executando") @db.VarChar(50) // executando, concluida, erro
  resultado     Json?
  erro          String?
  created_at    DateTime  @default(now())
  concluida_em  DateTime?

  regra regras_automacao @relation(fields: [regra_id], references: [id], onDelete: Cascade)

  @@index([regra_id])
  @@map("execucoes_automacao")
}